/*
 * result.c
 *
 *  Created on: Jan 10, 2023
 *      Author: fil
 */

#include "main.h"

const uint16_t	sine_in[NUM_SINEVAR] =
{
		0x0,0x1,0x2,0x6,0xa,0xf,0x16,0x1e,
		0x27,0x32,0x3d,0x4a,0x58,0x67,0x78,0x89,
		0x9c,0xb0,0xc5,0xdb,0xf2,0x10a,0x123,0x13e,
		0x159,0x175,0x193,0x1b1,0x1d1,0x1f1,0x212,0x235,
		0x258,0x27c,0x2a0,0x2c6,0x2ed,0x314,0x33c,0x365,
		0x38e,0x3b8,0x3e3,0x40e,0x43a,0x467,0x494,0x4c2,
		0x4f0,0x51f,0x54e,0x57d,0x5ad,0x5dd,0x60e,0x63f,
		0x670,0x6a1,0x6d3,0x705,0x737,0x769,0x79b,0x7cd,
		0x800,0x832,0x864,0x896,0x8c8,0x8fa,0x92c,0x95e,
		0x98f,0x9c0,0x9f1,0xa22,0xa52,0xa82,0xab1,0xae0,
		0xb0f,0xb3d,0xb6b,0xb98,0xbc5,0xbf1,0xc1c,0xc47,
		0xc71,0xc9a,0xcc3,0xceb,0xd12,0xd39,0xd5f,0xd83,
		0xda7,0xdca,0xded,0xe0e,0xe2e,0xe4e,0xe6c,0xe8a,
		0xea6,0xec1,0xedc,0xef5,0xf0d,0xf24,0xf3a,0xf4f,
		0xf63,0xf76,0xf87,0xf98,0xfa7,0xfb5,0xfc2,0xfcd,
		0xfd8,0xfe1,0xfe9,0xff0,0xff5,0xff9,0xffd,0xffe,
		0xfff,0xffe,0xffd,0xff9,0xff5,0xff0,0xfe9,0xfe1,
		0xfd8,0xfcd,0xfc2,0xfb5,0xfa7,0xf98,0xf87,0xf76,
		0xf63,0xf4f,0xf3a,0xf24,0xf0d,0xef5,0xedc,0xec1,
		0xea6,0xe8a,0xe6c,0xe4e,0xe2e,0xe0e,0xded,0xdca,
		0xda7,0xd83,0xd5f,0xd39,0xd12,0xceb,0xcc3,0xc9a,
		0xc71,0xc47,0xc1c,0xbf1,0xbc5,0xb98,0xb6b,0xb3d,
		0xb0f,0xae0,0xab1,0xa82,0xa52,0xa22,0x9f1,0x9c0,
		0x98f,0x95e,0x92c,0x8fa,0x8c8,0x896,0x864,0x832,
		0x800,0x7cd,0x79b,0x769,0x737,0x705,0x6d3,0x6a1,
		0x670,0x63f,0x60e,0x5dd,0x5ad,0x57d,0x54e,0x51f,
		0x4f0,0x4c2,0x494,0x467,0x43a,0x40e,0x3e3,0x3b8,
		0x38e,0x365,0x33c,0x314,0x2ed,0x2c6,0x2a0,0x27c,
		0x258,0x235,0x212,0x1f1,0x1d1,0x1b1,0x193,0x175,
		0x159,0x13e,0x123,0x10a,0xf2,0xdb,0xc5,0xb0,
		0x9c,0x89,0x78,0x67,0x58,0x4a,0x3d,0x32,
		0x27,0x1e,0x16,0xf,0xa,0x6,0x2,0x1,
};
uint16_t	sine_tab[NUM_SAMPLES];

const float amplitude_table[AMPLITUDE_TABLE_LEN] =
{
		0.3F,
		0.275F,
		0.25F,
		0.225F,
		0.2F,
		0.175F,
		0.15F,
		0.125F,
		0.1F,
		0.075F,
		0.05F,
		0.025F,
		0.0125F,
		0.01F,
};

const uint8_t amplitude_table_gain[AMPLITUDE_TABLE_LEN] =
{
		1,
		2,
		3,
		4,
		5,
		6,
		7,
		8,
		9,
		10,
		11,
		12,
		13,
		14
};

void scale_down_sine( void )
{
uint32_t	i,k=0;
	for(i=0;i<NUM_SAMPLES;i++)
		sine_tab[i] = 0;

	for(i=FLOOR_SAMPLES;i<NUM_SAMPLES-NUM_SINEVAR;i++)
	{
		sine_tab[i] = (uint16_t )((float )(sine_in[k]) * SystemVar.f_wave_amplitude + (float )SINE_OFFSET);
		k++;
		k &= 0xff;
	}
}

void set_wave_amplitude(uint8_t amplitude_index)
{
	if ( amplitude_index < AMPLITUDE_TABLE_LEN)
	{
		SystemVar.f_wave_amplitude = amplitude_table[amplitude_index];
	    scale_down_sine();
	}
}

void set_opamp_gain(uint32_t gain)
{
	SystemVar.pga_gain = gain;
	//ram_board_parameters.scale_factor = SystemVar.pga_gain >> 14;
	hopamp1.Init.PgaGain = gain;
	HAL_OPAMP_Init(&hopamp1);
}

#define	MAX_PEAK	(2048+64)
#define	MIN_PEAK	(2048-64)

void get_peak(void)
{
uint32_t	i;
uint32_t	adjust = 0;

	SystemVar.peak=0;
	SystemVar.f_floor_noise = 0.0F;
	for(i=FLOOR_START;i<FLOOR_END;i++)
	{
		SystemVar.f_floor_noise += (float )SystemVar.sensor_dma_data[i];
	}
	SystemVar.f_floor_noise = SystemVar.f_floor_noise / FLOOR_NUMBER;
	SystemVar.f_floor_noise /= (float )(amplitude_table_gain[SystemVar.wave_amplitude_index]);

	for(i=FLOOR_SAMPLES+256;i<NUM_SAMPLES-1024;i++)
	{
		if ( SystemVar.sensor_dma_data[i] > SystemVar.peak)
			SystemVar.peak = SystemVar.sensor_dma_data[i];
	}

	if ( SystemVar.peak > MAX_PEAK )
	{
		if ( SystemVar.wave_amplitude_index < (AMPLITUDE_TABLE_LEN - 1))
		{
			adjust = 1;
			SystemVar.wave_amplitude_index++;
		}
	}
	else
	{
		if ( SystemVar.peak < MIN_PEAK )
		{
			if ( SystemVar.wave_amplitude_index > 0 )
			{
				adjust = 2;
				SystemVar.wave_amplitude_index--;
			}
		}
	}
	if ( adjust )
		set_wave_amplitude(SystemVar.wave_amplitude_index);
}

void get_temperature(void)
{
	if ( ( SystemVar.system_flags & FLAGS_TEMP_COMPLETE) == FLAGS_TEMP_COMPLETE)
	{
		SystemVar.system_flags &= ~FLAGS_TEMP_COMPLETE;
		SystemVar.temperature[0] = SystemVar.running_temperature[0];
		SystemVar.temperature[1] = SystemVar.running_temperature[1];
		SystemVar.temperature[2] = SystemVar.running_temperature[2];
		SystemVar.temperature[3] = SystemVar.running_temperature[3];
		SystemVar.temperature[2] =  __LL_ADC_CALC_VREFANALOG_VOLTAGE(SystemVar.temperature[1],LL_ADC_RESOLUTION_12B);
		SystemVar.temperature[3] =  __LL_ADC_CALC_TEMPERATURE(SystemVar.temperature[2],SystemVar.temperature[0],LL_ADC_RESOLUTION_12B);
	}
}

void get_result(void)
{
	get_peak();
	get_temperature();
	SystemVar.pkt_indicator = 'V';
}

void send_results(void)
{
	sprintf((char *)SystemVar.uart_buf,"<%c %d %d %d %d>\r\n",
			SystemVar.pkt_indicator,
			(int )(SystemVar.peak),
			(int )(amplitude_table_gain[SystemVar.wave_amplitude_index]),
			(int )SystemVar.f_floor_noise,
			(int )SystemVar.temperature[3]);
	tx_uart();
}

